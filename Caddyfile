cat > Caddyfile <<'CADDY'
{
  email {$LE_EMAIL}
  auto_https on
}

# HTTP -> HTTPS
:80 {
  redir https://{$DOMAIN}{uri} permanent
}

# www -> apex
www.{$DOMAIN} {
  redir https://{$DOMAIN}{uri} permanent
}

# Site HTTPS
{$DOMAIN} {
  encode gzip zstd

  @health path /health
  respond @health 200

  reverse_proxy app:3000

  header {
    Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    Referrer-Policy "no-referrer-when-downgrade"
    X-Content-Type-Options "nosniff"
    X-Frame-Options "DENY"
    Permissions-Policy "geolocation=(), microphone=(), camera=()"
  }
}
CADDY
