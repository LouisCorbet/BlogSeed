{
  # adresse mail pour Let's Encrypt (issue/renew notices)
  email {$LE_EMAIL}
  auto_https on
}

# 1) Tout le HTTP → HTTPS (301)
:80 {
  redir https://{$DOMAIN}{uri} permanent
}

# 2) www → apex (HTTPS)
www.{$DOMAIN} {
  redir https://{$DOMAIN}{uri} permanent
}

# 3) Site en HTTPS avec reverse_proxy vers Next
{$DOMAIN} {
  encode gzip zstd

  @health path /health
  respond @health 200

  reverse_proxy app:3000

  header {
    Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    Referrer-Policy "no-referrer-when-downgrade"
    X-Content-Type-Options "nosniff"
    X-Frame-Options "DENY"
    Permissions-Policy "geolocation=(), microphone=(), camera=()"
  }
}
